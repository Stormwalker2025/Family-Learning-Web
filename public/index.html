<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Vocabulary Learning System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stats-card {
            text-align: center;
            padding: 30px;
        }

        .stats-number {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stats-label {
            font-size: 18px;
            color: #666;
        }

        .word-card {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
            padding: 40px;
        }

        .word-display {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .word-phonetics {
            font-size: 20px;
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }

        .word-pos {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .word-definition {
            font-size: 18px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .word-example {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            font-style: italic;
            color: #666;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .word-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .word-item {
            padding: 15px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-item:last-child {
            border-bottom: none;
        }

        .word-item:hover {
            background: #f8f9fa;
        }

        .review-schedule {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .schedule-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .schedule-day {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .schedule-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .admin-section {
            margin-top: 30px;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #764ba2;
        }

        .pronunciation-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .pronunciation-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        /* Flashcard styles */
        .flashcard-side {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
        }

        .flashcard-side.hidden {
            display: none;
        }

        #flashcardContainer {
            position: relative;
            overflow: hidden;
            min-height: 500px;
        }

        .flip-animation {
            animation: flipCard 0.6s ease-in-out;
        }

        @keyframes flipCard {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        /* Sentence fill exercise styles */
        #sentenceFillExercise {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sentence-correct {
            color: #4CAF50 !important;
            animation: bounce 0.5s ease;
        }

        .sentence-incorrect {
            color: #f44336 !important;
            animation: shake 0.5s ease;
        }

        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            80% { transform: translateY(-5px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .word-display {
                font-size: 36px;
            }
        }

        /* Math Expression Styles */
        .math-expression {
            font-family: 'Times New Roman', serif;
            font-size: 18px;
            line-height: 1.5;
            display: inline-block;
            vertical-align: middle;
        }

        .math-fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin: 0 3px;
        }

        .math-fraction .numerator {
            display: block;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
            margin-bottom: 2px;
        }

        .math-fraction .denominator {
            display: block;
            padding-top: 2px;
        }

        .math-operator {
            font-size: 20px;
            margin: 0 8px;
            font-weight: bold;
        }

        .question-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .answer-input {
            width: 200px;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            margin: 10px;
        }

        .answer-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .practice-question {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .practice-question h3 {
            color: #495057;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="card login-form">
            <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">English Vocabulary Learning</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <select id="username" class="form-control" required>
                        <option value="">Select your name</option>
                        <option value="Michael">Michael</option>
                        <option value="August">August</option>
                        <option value="Grace">Grace</option>
                        <option value="Dan">Dan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Start Learning</button>
            </form>
            <div id="loginError" style="color: red; text-align: center; margin-top: 10px; display: none;"></div>
            <div id="connectionStatus" style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                🔄 Checking server connection...
            </div>
        </div>

        <!-- Main Section -->
        <div id="mainSection" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="logo">📚 Vocabulary Learning</div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <button class="btn btn-primary" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardView">
                <div class="dashboard">
                    <div class="card stats-card">
                        <div class="stats-number" id="totalWords">0</div>
                        <div class="stats-label">Total Words</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="learnedWords">0</div>
                        <div class="stats-label">Learned Words</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="masteredWords">0</div>
                        <div class="stats-label">Mastered Words</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="todayReview">0</div>
                        <div class="stats-label">Today's Review</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="streak">0</div>
                        <div class="stats-label">Day Streak</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">📚 Your Learning Plan</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Daily New Words:</strong> <span style="color: #667eea;" id="userDailyLimit">10</span> words</p>
                        <p><strong>Daily Review Limit:</strong> <span style="color: #667eea;">100</span> words</p>
                        <p><strong>Today's Progress:</strong> 
                            <span id="todayLearnedDisplay">0</span> new + 
                            <span id="todayReviewedDisplay">0</span> reviewed
                        </p>
                    </div>
                    <div class="review-schedule">
                        <div class="schedule-item">
                            <div class="schedule-day">New Words</div>
                            <div class="schedule-count" id="todayNew">10</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-day">Review Due</div>
                            <div class="schedule-count" id="pendingReview">5</div>
                        </div>
                        <div class="schedule-item">
                            <div class="schedule-day">Weekly Goal</div>
                            <div class="schedule-count" id="weeklyGoal">70</div>
                        </div>
                    </div>
                </div>

                <!-- Daily Goals Section -->
                <div class="card">
                    <h3 style="margin-bottom: 20px;">📅 Today's Learning Goals</h3>
                    <div id="dailyGoalsContainer" style="margin-bottom: 20px;">
                        <!-- Daily goals will be loaded here -->
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="showGoalSetup()">Set Today's Goals</button>
                    </div>
                </div>

                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">📚 English Learning</h3>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="startLearning()">Learn New Words</button>
                        <button class="btn btn-warning" onclick="startReview()">Review Words</button>
                        <button class="btn btn-primary" onclick="showWordList()">Word List</button>
                    </div>
                </div>

                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">🔢 Math Learning</h3>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="showMathTopics()">Math Topics</button>
                        <button class="btn btn-warning" onclick="showMathPractice()">Practice Problems</button>
                        <button class="btn btn-info" onclick="showCustomQuestions()">My Questions</button>
                        <button class="btn btn-primary" onclick="showMathProgress()">Math Progress</button>
                    </div>
                </div>

                <div class="card" style="text-align: center;">
                    <h3 style="margin-bottom: 20px;">⚙️ System</h3>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button id="adminPanelBtn" class="btn btn-primary" onclick="showAdminPanel()" style="display: none;">Admin Panel</button>
                    </div>
                </div>
            </div>

            <!-- Learning View -->
            <div id="learningView" class="hidden">
                <div class="card">
                    <div class="progress-bar">
                        <div class="progress-fill" id="learningProgress" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <span id="progressText">1 / 10</span>
                    </div>
                </div>

                <!-- Flashcard Container -->
                <div class="card word-card" id="flashcardContainer">
                    <!-- Front of flashcard (word only) -->
                    <div id="flashcardFront" class="flashcard-side">
                        <div class="word-display" id="currentWord">Loading...</div>
                        <div class="word-phonetics" id="wordPhonetics">
                            <button class="pronunciation-btn" onclick="pronounceWord()" title="Pronounce">🔊</button>
                        </div>
                        <div style="margin: 30px 0;">
                            <button class="btn btn-primary" onclick="flipCard()" style="font-size: 18px; padding: 15px 30px;">
                                Show Answer 🔄
                            </button>
                        </div>
                    </div>

                    <!-- Back of flashcard (sentence fill exercise only) -->
                    <div id="flashcardBack" class="flashcard-side hidden">
                        <!-- Sentence Fill-in Exercise -->
                        <div id="sentenceFillExercise" style="margin: 25px 0; padding: 30px; background: #f0f8ff; border-radius: 15px; border-left: 4px solid #667eea; min-height: 200px;">
                            <h3 style="margin-bottom: 20px; color: #667eea; text-align: center;">🎯 Fill in the Blank</h3>
                            <div id="sentenceWithBlank" style="font-size: 18px; line-height: 1.8; margin-bottom: 25px; color: #333; text-align: center; font-weight: 500;"></div>
                            <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 20px;">
                                <input type="text" id="sentenceInput" class="form-control" style="max-width: 250px; text-align: center; font-size: 16px; padding: 12px;" placeholder="Your answer...">
                                <button class="btn btn-primary" onclick="checkSentenceAnswer()" style="padding: 12px 25px; font-size: 16px;">Submit</button>
                            </div>
                            <div id="sentenceResult" style="margin-top: 15px; font-weight: bold; text-align: center; font-size: 16px;"></div>
                            
                            <!-- Show Answer Button (only appears after checking) -->
                            <div id="revealAnswerSection" style="margin-top: 20px; text-align: center; display: none;">
                                <button class="btn btn-warning" onclick="revealAnswer()" style="padding: 10px 20px;">Show Full Answer 👁️</button>
                            </div>
                        </div>

                        <!-- Answer Details (hidden by default) -->
                        <div id="answerDetails" class="hidden" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; animation: slideIn 0.5s ease-out;">
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div class="word-display" style="font-size: 36px; color: #667eea; margin-bottom: 5px;" id="currentWordBack">Loading...</div>
                                <div class="word-phonetics" id="wordPhoneticsBack" style="font-size: 18px; color: #666;">
                                    <button class="pronunciation-btn" onclick="pronounceWord()" title="Pronounce">🔊</button>
                                </div>
                                <div class="word-pos" id="wordPos" style="display: inline-block; background: #667eea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin: 10px 0;"></div>
                            </div>
                            <div class="word-definition" id="wordDefinition" style="font-size: 16px; color: #555; margin-bottom: 15px; text-align: center;"></div>
                            <div class="word-example" id="wordExample" style="background: #e8f5e8; padding: 15px; border-radius: 8px; font-style: italic; color: #666; text-align: center;"></div>
                        </div>
                        
                        <!-- Familiarity Progress -->
                        <div id="familiarityProgress" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #667eea;">Familiarity Level</span>
                                <span id="familiarityPercentage" style="font-size: 14px; color: #666;">0%</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: #e1e5e9; border-radius: 4px; overflow: hidden;">
                                <div id="familiarityBar" style="height: 100%; background: linear-gradient(90deg, #ff9800 0%, #4CAF50 100%); width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                            </div>
                            <div id="familiarityDetails" style="margin-top: 8px; font-size: 12px; color: #666;">
                                <span id="correctCount">0</span> correct out of <span id="totalCount">0</span> attempts
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="nextWord()" style="font-size: 18px; padding: 15px 30px;">
                                Next Word ➡️
                            </button>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Word List View -->
            <div id="wordListView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">My Word List</h3>
                    <div class="form-group">
                        <input type="text" id="searchWords" class="form-control" placeholder="Search words...">
                    </div>
                    <div class="word-list" id="wordListContainer">
                        <!-- Word list will be generated here -->
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Math Topics View -->
            <div id="mathTopicsView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">🔢 Mathematics Learning Topics</h3>
                    
                    <!-- Grade Level Filter -->
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label for="gradeFilter" style="margin-right: 10px; font-weight: bold;">Grade Level:</label>
                        <select id="gradeFilter" class="form-control" style="width: 200px; display: inline-block;" onchange="filterMathTopics()">
                            <option value="">All Grades</option>
                            <option value="Year 3">Year 3</option>
                            <option value="Year 4">Year 4</option>
                            <option value="Year 5">Year 5</option>
                            <option value="Year 6">Year 6</option>
                            <option value="Year 7">Year 7</option>
                            <option value="Year 8">Year 8</option>
                            <option value="Year 9">Year 9</option>
                        </select>
                    </div>
                    
                    <div id="mathTopicsContainer">
                        <!-- Math topics will be loaded here -->
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Math Practice View -->
            <div id="mathPracticeView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">🔢 Math Practice Problems</h3>
                    
                    <!-- Topic Selection -->
                    <div style="margin-bottom: 20px;">
                        <label for="practiceTopicSelect" style="font-weight: bold; margin-bottom: 10px; display: block;">Choose a Topic to Practice:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="practiceTopicSelect" class="form-control" style="min-width: 300px;">
                                <option value="">Select a math topic...</option>
                            </select>
                            <select id="practiceDifficulty" class="form-control" style="width: 120px;">
                                <option value="">All Levels</option>
                                <option value="1">Easy</option>
                                <option value="2">Medium</option>
                                <option value="3">Hard</option>
                                <option value="4">Expert</option>
                            </select>
                            <button class="btn btn-primary" onclick="startPracticeSession()">Start Practice</button>
                        </div>
                    </div>
                    
                    <!-- Practice Session Area -->
                    <div id="practiceSessionArea" style="display: none;">
                        <!-- Current Problem -->
                        <div id="currentProblem" class="card" style="margin: 20px 0; padding: 30px; background: #f0f8ff; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                                <h4 style="color: #667eea; margin: 0;">Problem <span id="currentProblemNumber">1</span> of <span id="totalProblems">5</span></h4>
                                <div id="timer" style="font-weight: bold; color: #666;">Time: 00:00</div>
                            </div>
                            
                            <div id="problemQuestion" style="font-size: 18px; margin-bottom: 25px; line-height: 1.6;"></div>
                            
                            <!-- Multiple Choice Options -->
                            <div id="multipleChoiceOptions" style="display: none; margin-bottom: 20px;">
                                <div id="optionsContainer"></div>
                            </div>
                            
                            <!-- Short Answer Input -->
                            <div id="shortAnswerInput" style="display: none; margin-bottom: 20px;">
                                <input type="text" id="answerInput" class="form-control" style="max-width: 300px; font-size: 16px;" placeholder="Enter your answer...">
                            </div>
                            
                            <div style="text-align: center;">
                                <button id="submitAnswer" class="btn btn-success" onclick="submitPracticeAnswer()" style="padding: 12px 30px; font-size: 16px;">Submit Answer</button>
                            </div>
                        </div>
                        
                        <!-- Answer Result -->
                        <div id="answerResult" style="display: none; margin: 20px 0; padding: 20px; border-radius: 10px;">
                            <div id="resultMessage" style="font-size: 18px; font-weight: bold; margin-bottom: 15px;"></div>
                            <div id="correctAnswer" style="margin-bottom: 15px;"></div>
                            <div id="explanation" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-style: italic;"></div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button id="nextProblem" class="btn btn-primary" onclick="loadNextProblem()" style="padding: 10px 25px;">Next Problem ➡️</button>
                            </div>
                        </div>
                        
                        <!-- Session Complete -->
                        <div id="sessionComplete" style="display: none; text-align: center; padding: 30px;">
                            <h3 style="color: #4CAF50;">🎉 Practice Session Complete!</h3>
                            <div id="sessionStats" style="margin: 20px 0; font-size: 18px;"></div>
                            <button class="btn btn-success" onclick="startNewSession()">Practice More</button>
                            <button class="btn btn-primary" onclick="backToDashboard()" style="margin-left: 10px;">Back to Home</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Custom Questions View -->
            <div id="customQuestionsView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">📝 My Custom Questions</h3>
                    
                    <!-- Upload new questions -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">📤 Upload New Questions</h4>
                        <textarea id="questionsContent" class="form-control" style="height: 150px; margin-bottom: 15px;" placeholder="Paste your questions here in the format:&#10;&#10;For August&#10;1. 24 + 18 =&#10;2. 56 - 29 =&#10;&#10;For Michael&#10;1. 345 + 278 =&#10;2. \frac{3}{4} + \frac{1}{8} ="></textarea>
                        <div style="text-align: center;">
                            <button class="btn btn-success" onclick="uploadCustomQuestions()">📤 Upload Questions</button>
                            <button class="btn btn-info" onclick="loadCustomQuestions()" style="margin-left: 10px;">🔄 Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Questions list -->
                    <div id="customQuestionsList">
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <p>No custom questions found. Upload some questions above!</p>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                    <button class="btn btn-success" onclick="startQuestionPractice()" style="margin-left: 10px;">🎯 Start Practice</button>
                </div>
            </div>

            <!-- Question Practice View -->
            <div id="questionPracticeView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px; text-align: center;">🎯 Math Practice Session</h3>
                    
                    <!-- Practice Status -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">0</span></strong>
                            </div>
                            <div>
                                <span id="practiceTimer">Time: 00:00</span>
                            </div>
                            <div>
                                <span>Correct: <span id="correctAnswers">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Current Question Display -->
                    <div id="currentQuestionDisplay" class="practice-question">
                        <div id="questionText" class="question-text">
                            Select questions to start practice
                        </div>
                        <div style="margin: 20px 0;">
                            <input type="text" id="studentAnswer" class="answer-input" placeholder="Your answer..." disabled>
                        </div>
                        <div>
                            <button id="submitAnswerBtn" class="btn btn-primary" onclick="submitStudentAnswer()" disabled>Submit Answer</button>
                            <button id="nextQuestionBtn" class="btn btn-success hidden" onclick="nextQuestion()">Next Question →</button>
                        </div>
                    </div>

                    <!-- Answer Feedback -->
                    <div id="answerFeedback" class="hidden" style="margin: 20px 0; padding: 15px; border-radius: 8px;">
                        <div id="feedbackMessage"></div>
                        <div id="correctAnswerDisplay" style="margin-top: 10px;"></div>
                    </div>

                    <!-- Practice Results -->
                    <div id="practiceResults" class="hidden" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; text-align: center;">
                        <h4>🎉 Practice Complete!</h4>
                        <div id="finalStats" style="margin: 20px 0;">
                            <!-- Results will be inserted here -->
                        </div>
                        <button class="btn btn-primary" onclick="restartPractice()">Practice Again</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showCustomQuestions()">← Back to Questions</button>
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Goal Setup View -->
            <div id="goalSetupView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">🎯 Set Today's Learning Goals</h3>
                    
                    <form id="goalSetupForm">
                        <div class="form-group">
                            <label><strong>📚 English Vocabulary Goal</strong></label>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                <span>Learn</span>
                                <input type="number" id="vocabGoalCount" class="form-control" style="width: 80px;" value="5" min="1" max="20">
                                <span>new words today</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><strong>🔄 Vocabulary Review Goal</strong></label>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                <span>Review</span>
                                <input type="number" id="reviewGoalCount" class="form-control" style="width: 80px;" value="10" min="1" max="50">
                                <span>words today</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><strong>🔢 Math Topic Goal</strong></label>
                            <div style="margin-top: 10px;">
                                <select id="mathTopicSelect" class="form-control">
                                    <option value="">Select a math topic to study today</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><strong>📖 Reading Goal</strong></label>
                            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                <span>Read for</span>
                                <input type="number" id="readingGoalMinutes" class="form-control" style="width: 80px;" value="30" min="10" max="120">
                                <span>minutes today</span>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="button" class="btn btn-success" onclick="createDailyGoals()" style="padding: 12px 30px; font-size: 16px;">
                                ✅ Set Today's Goals
                            </button>
                        </div>
                    </form>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>

            <!-- Admin Panel -->
            <div id="adminView" class="hidden">
                <div class="card">
                    <h3 style="margin-bottom: 20px;">Admin Panel</h3>
                    
                    <div class="admin-section">
                        <h4>Import Word CSV File</h4>
                        <div class="file-upload" id="fileUpload">
                            <p>📁 Click or drag CSV file here</p>
                            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                                <strong>CSV format example:</strong><br>
                                word<br>
                                apple<br>
                                computer<br>
                                knowledge
                            </p>
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">
                                💡 The system will automatically get definitions, pronunciations, and examples from the dictionary API
                            </p>
                        </div>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px;">
                            <strong>📋 How to import your CSV file:</strong><br>
                            1. Create a CSV file with one column: <code>word</code><br>
                            2. Save as UTF-8 encoding<br>
                            3. Click above or drag the file here<br>
                            4. Wait for processing (may take time for many words)<br>
                            5. Words will appear in the vocabulary list
                        </div>
                        
                        <!-- Test CSV button -->
                        <div style="margin-top: 10px; text-align: center;">
                            <button class="btn btn-primary" onclick="createTestCSV()" style="padding: 8px 16px; font-size: 14px;">
                                📄 Create Test CSV File
                            </button>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                Downloads a sample CSV file for testing
                            </p>
                        </div>
                        
                        <div id="uploadStatus" style="margin-top: 10px; padding: 10px; border-radius: 5px; display: none;">
                            <!-- Upload status messages will appear here -->
                        </div>
                        
                        <!-- Upload Progress Bar -->
                        <div id="uploadProgress" style="margin-top: 15px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="font-weight: bold; color: #667eea;">Upload Progress</span>
                                <span id="uploadPercentage" style="font-size: 14px; color: #666;">0%</span>
                            </div>
                            <div style="width: 100%; height: 12px; background: #e1e5e9; border-radius: 6px; overflow: hidden;">
                                <div id="uploadProgressBar" style="height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); width: 0%; transition: width 0.3s ease; border-radius: 6px;"></div>
                            </div>
                            <div id="uploadDetails" style="margin-top: 8px; font-size: 12px; color: #666;">
                                Preparing upload...
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h4>System Status</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <p><strong>Dictionary API Status:</strong> <span id="apiStatus">Connecting...</span></p>
                            <p><strong>Database Status:</strong> <span id="dbStatus">Normal</span></p>
                            <p><strong>Vocabulary Size:</strong> <span id="vocabSize">0</span> words</p>
                            <p><strong>Speech Synthesis:</strong> <span id="speechStatus">Checking...</span></p>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h4>Actions</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-warning" onclick="refreshDictionary()">Refresh Dictionary</button>
                            <button class="btn btn-danger" onclick="resetProgress()">Reset Progress</button>
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-success" onclick="testPronunciation()">🔊 Test Pronunciation</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary" onclick="backToDashboard()">Back to Home</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUser = null;
        let words = [];
        let userProgress = {};
        let currentWordIndex = 0;
        let learningSession = [];
        let isReviewMode = false;
        let currentWord = null;
        let isFlashcardFlipped = false;
        let sentenceAnswerChecked = false;
        let currentWordCorrect = false;

        // Spaced repetition intervals (days)
        const SPACED_REPETITION_INTERVALS = [1, 3, 7, 14, 30, 90];

        // Student accounts and settings
        const STUDENT_ACCOUNTS = {
            'Michael': { password: '123456', dailyNewWords: 10 },
            'August': { password: '645321', dailyNewWords: 10 },
            'Grace': { password: 'Kappa2004', dailyNewWords: 5 },
            'Dan': { password: 'Kappa2004', dailyNewWords: 5 }
        };

        const MAX_DAILY_REVIEW = 100; // Maximum daily review words for everyone
        
        // API Base URL - dynamically determine based on current host
        const API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:3000/api`;
        
        // Debug: Log the API URL
        console.log('API Base URL:', API_BASE_URL);
        
        // Test server connectivity
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                console.log('Testing server connection...');
                const response = await fetch(`${API_BASE_URL}/health`, { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                console.log('Connection test result:', response.status, response.statusText);
                
                if (response.ok) {
                    if (statusEl) {
                        statusEl.innerHTML = '✅ Server connected';
                        statusEl.style.color = '#4CAF50';
                    }
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                if (statusEl) {
                    statusEl.innerHTML = `❌ Connection failed: ${error.message}`;
                    statusEl.style.color = '#f44336';
                }
                return false;
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', async function() {
            words = loadSampleWords(); // Load sample words first
            setupEventListeners();
            
            // Test server connection first
            const connected = await testConnection();
            if (!connected) {
                console.warn('Server connection failed. Some features may not work.');
            }
            
            checkApiStatus();
            
            // Initialize speech synthesis
            initializeVoices();
            
            // Check for saved login state
            checkSavedLogin();
            
            // Load words from server after initialization
            setTimeout(async function() {
                if (connected) {
                    try {
                        await loadWordsFromServer();
                    } catch (error) {
                        console.log('Using sample words only:', error);
                    }
                } else {
                    console.log('Skipping server word loading due to connection issues');
                }
            }, 100);
        });

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // File upload listeners
            const fileUpload = document.getElementById('fileUpload');
            const csvFile = document.getElementById('csvFile');
            
            // Click to upload
            fileUpload.addEventListener('click', () => {
                csvFile.click();
            });
            
            // File selection change
            csvFile.addEventListener('change', handleCSVUpload);
            
            // Word search
            document.getElementById('searchWords').addEventListener('input', handleWordSearch);

            // Drag and drop upload
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('dragover');
                fileUpload.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                fileUpload.style.borderColor = '#764ba2';
            });
            
            fileUpload.addEventListener('dragleave', (e) => {
                // Only remove styling if we're actually leaving the drop zone
                if (!fileUpload.contains(e.relatedTarget)) {
                    fileUpload.classList.remove('dragover');
                    fileUpload.style.backgroundColor = '';
                    fileUpload.style.borderColor = '';
                }
            });
            
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                fileUpload.style.backgroundColor = '';
                fileUpload.style.borderColor = '';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Clear previous error
            document.getElementById('loginError').style.display = 'none';
            
            // Check if username exists and password is correct
            if (!username) {
                showLoginError('Please select a username');
                return;
            }
            
            if (!STUDENT_ACCOUNTS[username]) {
                showLoginError('Invalid username');
                return;
            }
            
            if (STUDENT_ACCOUNTS[username].password !== password) {
                showLoginError('Incorrect password');
                return;
            }
            
            try {
                console.log('Attempting login with URL:', `${API_BASE_URL}/auth/login`);
                
                // Login to server (no level needed anymore)
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Login result:', result);
                
                if (result.user) {
                    currentUser = { 
                        id: result.user.id,
                        username, 
                        dailyNewWords: STUDENT_ACCOUNTS[username].dailyNewWords
                    };
                    
                    // Save login state to localStorage
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    loadUserProgress();
                    showMainSection();
                } else {
                    showLoginError('Login failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Login error details:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showLoginError('Connection failed: Cannot reach server. Please check your network connection.');
                } else {
                    showLoginError('Login failed: ' + error.message);
                }
            }
        }

        // Show login error
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Show main section
        function showMainSection() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser.username;
            
            // Show admin panel button only for Dan
            const adminBtn = document.getElementById('adminPanelBtn');
            if (currentUser.username === 'Dan') {
                adminBtn.style.display = 'inline-block';
            } else {
                adminBtn.style.display = 'none';
            }
            
            updateDashboard();
            loadDailyGoals();
            showView('dashboardView');
        }

        // Load words from server
        async function loadWordsFromServer() {
            try {
                const response = await fetch(`${API_BASE_URL}/words/all`);
                if (response.ok) {
                    const serverWords = await response.json();
                    if (serverWords && serverWords.length > 0) {
                        words = serverWords;
                        console.log(`Loaded ${words.length} words from server`);
                        return words;
                    }
                }
            } catch (error) {
                console.error('Failed to load words from server:', error);
            }
            throw new Error('Failed to load from server');
        }

        // Load sample words
        function loadSampleWords() {
            words = [
                {
                    word: 'apple',
                    phonetics: '/ˈæpəl/',
                    pos: 'noun',
                    definition: 'A round fruit with red or green skin and firm white flesh',
                    example: 'I eat an apple every day for good health.'
                },
                {
                    word: 'beautiful',
                    phonetics: '/ˈbjuːtɪfʊl/',
                    pos: 'adjective',
                    definition: 'Pleasing the senses or mind aesthetically',
                    example: 'The sunset was beautiful tonight.'
                },
                {
                    word: 'education',
                    phonetics: '/ˌedʒʊˈkeɪʃən/',
                    pos: 'noun',
                    definition: 'The process of receiving or giving systematic instruction',
                    example: 'Education is the key to success in life.'
                },
                {
                    word: 'wonderful',
                    phonetics: '/ˈwʌndərfʊl/',
                    pos: 'adjective',
                    definition: 'Inspiring delight, pleasure, or admiration; extremely good',
                    example: 'We had a wonderful time at the party.'
                },
                {
                    word: 'accomplish',
                    phonetics: '/əˈkʊmplɪʃ/',
                    pos: 'verb',
                    definition: 'Achieve or complete successfully',
                    example: 'She accomplished all her goals through hard work.'
                }
            ];
        }

        // Load user progress
        function loadUserProgress() {
            const saved = localStorage.getItem(`progress_${currentUser.username}`);
            if (saved) {
                userProgress = JSON.parse(saved);
            } else {
                userProgress = {
                    learnedWords: [],
                    reviewSchedule: {},
                    streak: 0,
                    lastStudyDate: null,
                    todayLearned: 0,
                    todayReviewed: 0
                };
            }
            
            // Reset daily counters if it's a new day
            const today = new Date().toDateString();
            if (userProgress.lastStudyDate !== today) {
                userProgress.todayLearned = 0;
                userProgress.todayReviewed = 0;
            }
        }

        // Save user progress
        function saveUserProgress() {
            localStorage.setItem(`progress_${currentUser.username}`, JSON.stringify(userProgress));
        }

        // Update dashboard
        async function updateDashboard() {
            if (!currentUser || !currentUser.id) return;
            
            try {
                // Get statistics from server
                const response = await fetch(`${API_BASE_URL}/stats/${currentUser.id}`);
                const stats = await response.json();
                
                document.getElementById('totalWords').textContent = stats.totalWords || 0;
                document.getElementById('learnedWords').textContent = stats.learnedWords || 0;
                document.getElementById('masteredWords').textContent = stats.masteredWords || 0;
                document.getElementById('todayReview').textContent = stats.todayReview || 0;
                document.getElementById('streak').textContent = stats.streak || 0;
                
                // Update learning plan with personalized settings
                const remainingWords = Math.max(0, stats.totalWords - stats.learnedWords);
                const todayNewWords = Math.min(currentUser.dailyNewWords, remainingWords);
                
                document.getElementById('todayNew').textContent = todayNewWords;
                document.getElementById('pendingReview').textContent = stats.todayReview || 0;
                document.getElementById('weeklyGoal').textContent = currentUser.dailyNewWords * 7;
                
                // Update user-specific information
                document.getElementById('userDailyLimit').textContent = currentUser.dailyNewWords;
                document.getElementById('todayLearnedDisplay').textContent = userProgress.todayLearned || 0;
                document.getElementById('todayReviewedDisplay').textContent = userProgress.todayReviewed || 0;
                
            } catch (error) {
                console.error('Failed to update dashboard:', error);
                // Fallback to local data
                const learnedCount = userProgress.learnedWords ? userProgress.learnedWords.length : 0;
                
                document.getElementById('totalWords').textContent = words.length;
                document.getElementById('learnedWords').textContent = learnedCount;
                document.getElementById('masteredWords').textContent = 0;
                document.getElementById('todayReview').textContent = 0;
                document.getElementById('streak').textContent = userProgress.streak || 0;
            }
        }

        // Get today's review count
        function getTodayReviewCount() {
            const today = new Date().toDateString();
            let count = 0;
            for (let word in userProgress.reviewSchedule) {
                if (userProgress.reviewSchedule[word] === today) {
                    count++;
                }
            }
            return count;
        }

        // Show specific view
        function showView(viewId) {
            const views = ['dashboardView', 'learningView', 'wordListView', 'adminView', 'mathTopicsView', 'goalSetupView', 'mathPracticeView', 'customQuestionsView', 'questionPracticeView'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }

        // Start learning new words
        async function startLearning() {
            if (!currentUser || !currentUser.id) return;
            
            isReviewMode = false;
            
            try {
                const response = await fetch(`${API_BASE_URL}/learning/${currentUser.id}?type=learn`);
                const newWords = await response.json();
                
                if (newWords.length === 0) {
                    alert('Congratulations! You have learned all available words at your level!');
                    return;
                }
                
                learningSession = newWords;
                currentWordIndex = 0;
                showView('learningView');
                showCurrentWord();
                
            } catch (error) {
                console.error('Failed to get learning words:', error);
                alert('Failed to load new words. Please try again.');
            }
        }

        // Get today's learned words count
        function getTodayLearnedCount() {
            const today = new Date().toDateString();
            if (userProgress.lastStudyDate !== today) {
                return 0;
            }
            return userProgress.todayLearned || 0;
        }

        // Start review
        async function startReview() {
            if (!currentUser || !currentUser.id) return;
            
            isReviewMode = true;
            
            try {
                const response = await fetch(`${API_BASE_URL}/learning/${currentUser.id}?type=review`);
                const reviewWords = await response.json();
                
                if (reviewWords.length === 0) {
                    alert('No words to review today! All caught up!');
                    return;
                }
                
                learningSession = reviewWords;
                currentWordIndex = 0;
                showView('learningView');
                showCurrentWord();
                
            } catch (error) {
                console.error('Failed to get review words:', error);
                alert('Failed to load review words. Please try again.');
            }
        }

        // Get today's reviewed words count
        function getTodayReviewedCount() {
            const today = new Date().toDateString();
            if (userProgress.lastStudyDate !== today) {
                return 0;
            }
            return userProgress.todayReviewed || 0;
        }

        // Show current word
        function showCurrentWord() {
            if (currentWordIndex >= learningSession.length) {
                finishLearningSession();
                return;
            }
            
            const word = learningSession[currentWordIndex];
            currentWord = word;
            isFlashcardFlipped = false;
            sentenceAnswerChecked = false;
            currentWordCorrect = false;
            
            // Reset flashcard to front side
            showFlashcardFront();
            
            // Update front side
            document.getElementById('currentWord').textContent = word.word;
            const phoneticsDiv = document.getElementById('wordPhonetics');
            phoneticsDiv.innerHTML = `${word.phonetics || ''} <button class="pronunciation-btn" onclick="pronounceWord()" title="Pronounce">🔊</button>`;
            
            // Update back side (but keep hidden initially)
            document.getElementById('currentWordBack').textContent = word.word;
            const phoneticsBackDiv = document.getElementById('wordPhoneticsBack');
            phoneticsBackDiv.innerHTML = `${word.phonetics || ''} <button class="pronunciation-btn" onclick="pronounceWord()" title="Pronounce">🔊</button>`;
            document.getElementById('wordPos').textContent = word.pos || '';
            document.getElementById('wordDefinition').textContent = word.definition || '';
            document.getElementById('wordExample').innerHTML = 
                `<strong>Example:</strong> ${word.example || ''}`;
            
            // Generate sentence fill exercise
            generateSentenceFillExercise(word);
            
            // Show familiarity progress if word has been studied before
            if (word.familiarity_level !== undefined && word.familiarity_level !== null) {
                const familiarityDiv = document.getElementById('familiarityProgress');
                const familiarityBar = document.getElementById('familiarityBar');
                const familiarityPercentage = document.getElementById('familiarityPercentage');
                const correctCount = document.getElementById('correctCount');
                const totalCount = document.getElementById('totalCount');
                
                const familiarity = (word.familiarity_level || 0) * 100;
                const correct = word.correct_answers || 0;
                const total = word.total_attempts || 0;
                
                familiarityDiv.style.display = 'block';
                familiarityBar.style.width = `${familiarity}%`;
                familiarityPercentage.textContent = `${Math.round(familiarity)}%`;
                correctCount.textContent = correct;
                totalCount.textContent = total;
                
                if (word.is_mastered) {
                    familiarityDiv.style.background = '#e8f5e8';
                    familiarityPercentage.innerHTML = '100% ✅ Mastered';
                }
            } else {
                document.getElementById('familiarityProgress').style.display = 'none';
            }
            
            // Update progress
            const progress = ((currentWordIndex) / learningSession.length) * 100;
            document.getElementById('learningProgress').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `${currentWordIndex + 1} / ${learningSession.length}`;
        }

        // Pronounce word using Web Speech API (American English)
        function pronounceWord() {
            if (!currentWord) {
                alert('No word to pronounce');
                return;
            }

            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(currentWord.word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                // Use cached best voice or find new one
                let americanVoice = window.bestAmericanVoice;
                if (!americanVoice) {
                    const voices = speechSynthesis.getVoices();
                    americanVoice = findBestAmericanVoice(voices);
                    window.bestAmericanVoice = americanVoice;
                }
                
                if (americanVoice) {
                    utterance.voice = americanVoice;
                    console.log(`Using voice: ${americanVoice.name} (${americanVoice.lang})`);
                } else {
                    console.warn('No American English voice found, using default');
                }
                
                utterance.onstart = function() {
                    console.log(`Pronouncing: ${currentWord.word}`);
                };
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                    // Try fallback pronunciation
                    if (event.error === 'voice-unavailable') {
                        setTimeout(() => {
                            const fallbackUtterance = new SpeechSynthesisUtterance(currentWord.word);
                            fallbackUtterance.lang = 'en-US';
                            fallbackUtterance.rate = 0.8;
                            speechSynthesis.speak(fallbackUtterance);
                        }, 100);
                    } else {
                        alert('Pronunciation failed. Please try again.');
                    }
                };
                
                speechSynthesis.speak(utterance);
            } else {
                alert('Speech synthesis not supported in this browser. Try Chrome, Edge, or Firefox.');
            }
        }
        
        // Find the best American English voice
        function findBestAmericanVoice(voices) {
            // Priority order for American English voices
            const preferredVoices = [
                // Windows voices
                'Microsoft Zira Desktop - English (United States)',
                'Microsoft David Desktop - English (United States)',
                'Microsoft Mark Desktop - English (United States)',
                // macOS voices
                'Alex',
                'Samantha',
                'Victoria',
                // Chrome/Android voices
                'Google US English',
                'Chrome OS US English',
                // Generic patterns
                'en-US',
                'English (United States)'
            ];
            
            // First, try to find exact matches
            for (const preferred of preferredVoices) {
                const voice = voices.find(v => v.name === preferred);
                if (voice) return voice;
            }
            
            // Then try pattern matching for American voices
            let americanVoice = voices.find(voice => 
                voice.lang === 'en-US' && (
                    voice.name.toLowerCase().includes('united states') ||
                    voice.name.toLowerCase().includes('american') ||
                    voice.name.toLowerCase().includes('us english')
                )
            );
            
            if (americanVoice) return americanVoice;
            
            // Fallback to any en-US voice
            americanVoice = voices.find(voice => voice.lang === 'en-US');
            if (americanVoice) return americanVoice;
            
            // Last resort: any English voice
            return voices.find(voice => voice.lang.startsWith('en'));
        }

        // Load and initialize voices
        function loadVoices() {
            if ('speechSynthesis' in window) {
                const voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.length);
                
                // Log American English voices
                const americanVoices = voices.filter(voice => voice.lang === 'en-US');
                console.log('American English voices:', americanVoices.map(v => `${v.name} (${v.lang})`));
                
                // Store the best voice for quick access
                window.bestAmericanVoice = findBestAmericanVoice(voices);
                if (window.bestAmericanVoice) {
                    console.log(`Best American voice selected: ${window.bestAmericanVoice.name}`);
                    
                    // Update admin panel if it exists
                    const speechStatusElement = document.getElementById('speechStatus');
                    if (speechStatusElement) {
                        speechStatusElement.innerHTML = `${window.bestAmericanVoice.name} <span style="color: #4CAF50;">✓</span>`;
                    }
                }
                
                return voices;
            }
            return [];
        }

        // Initialize voices on different events
        function initializeVoices() {
            // Multiple attempts to load voices due to browser differences
            setTimeout(loadVoices, 100);
            setTimeout(loadVoices, 500);
            setTimeout(loadVoices, 1000);
        }

        // Load voices on page load and when voices change
        window.addEventListener('load', initializeVoices);
        document.addEventListener('DOMContentLoaded', initializeVoices);
        
        if ('speechSynthesis' in window) {
            speechSynthesis.addEventListener('voiceschanged', loadVoices);
        }

        // Next word function (replaces manual difficulty selection)
        function nextWord() {
            if (!sentenceAnswerChecked) {
                alert('Please complete the fill-in-the-blank exercise first!');
                return;
            }
            
            // Automatically determine difficulty based on answer correctness
            const difficulty = currentWordCorrect ? 'easy' : 'difficult';
            markWord(difficulty);
        }

        // Mark word and schedule review (now automatic based on correctness)
        async function markWord(difficulty) {
            if (!currentUser || !currentUser.id) return;
            
            const word = learningSession[currentWordIndex];
            
            try {
                const response = await fetch(`${API_BASE_URL}/study`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        wordId: word.id,
                        difficulty: difficulty,
                        sessionType: isReviewMode ? 'review' : 'learn'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success feedback
                    if (result.isMastered) {
                        alert(`🎉 Congratulations! You have mastered "${word.word}"!`);
                    }
                    
                    // Update local progress counters
                    if (!isReviewMode) {
                        userProgress.todayLearned = (userProgress.todayLearned || 0) + 1;
                    } else {
                        userProgress.todayReviewed = (userProgress.todayReviewed || 0) + 1;
                    }
                    
                    saveUserProgress();
                    
                    currentWordIndex++;
                    showCurrentWord();
                } else {
                    alert('Failed to record your answer. Please try again.');
                }
                
            } catch (error) {
                console.error('Failed to mark word:', error);
                alert('Failed to record your answer. Please try again.');
            }
        }

        // Finish learning session
        function finishLearningSession() {
            const message = isReviewMode ? 
                `Great! You reviewed ${learningSession.length} words!` :
                `Excellent! You learned ${learningSession.length} new words!`;
            
            alert(message);
            updateStreak();
            backToDashboard();
        }

        // Update learning streak
        function updateStreak() {
            const today = new Date().toDateString();
            const lastStudy = userProgress.lastStudyDate;
            
            if (lastStudy === today) {
                return;
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastStudy === yesterday.toDateString()) {
                userProgress.streak++;
            } else if (lastStudy !== today) {
                userProgress.streak = 1;
            }
            
            userProgress.lastStudyDate = today;
            saveUserProgress();
        }

        // Show word list
        function showWordList() {
            showView('wordListView');
            displayWordList();
        }

        // Display word list
        async function displayWordList(searchTerm = '') {
            if (!currentUser || !currentUser.id) return;
            
            const container = document.getElementById('wordListContainer');
            
            try {
                const response = await fetch(`${API_BASE_URL}/words/${currentUser.id}`);
                const userWords = await response.json();
                
                const filteredWords = searchTerm ? 
                    userWords.filter(w => w.word.toLowerCase().includes(searchTerm.toLowerCase())) :
                    userWords;
                
                container.innerHTML = '';
                
                filteredWords.forEach(word => {
                    const div = document.createElement('div');
                    div.className = 'word-item';
                    
                    let statusText = 'Not learned';
                    let statusColor = '#999';
                    
                    if (word.is_mastered) {
                        statusText = '✅ Mastered (100%)';
                        statusColor = '#4CAF50';
                    } else if (word.familiarity_level > 0) {
                        const familiarity = Math.round(word.familiarity_level * 100);
                        statusText = `📚 Learning (${familiarity}%)`;
                        statusColor = '#ff9800';
                    }
                    
                    div.innerHTML = `
                        <div>
                            <strong>${word.word}</strong> ${word.phonetics || ''}
                            <button class="pronunciation-btn" onclick="pronounceWordInList('${word.word}')" title="Pronounce" style="margin-left: 8px;">🔊</button>
                            <br><small>${word.definition || ''}</small>
                            ${word.correct_answers ? `<br><small style="color: #666">${word.correct_answers} correct out of ${word.total_attempts} attempts</small>` : ''}
                        </div>
                        <div style="color: ${statusColor}">
                            ${statusText}
                        </div>
                    `;
                    container.appendChild(div);
                });
                
            } catch (error) {
                console.error('Failed to load word list:', error);
                container.innerHTML = '<div style="text-align: center; color: #666;">Failed to load word list</div>';
            }
        }

        // Search words
        function handleWordSearch(e) {
            displayWordList(e.target.value);
        }

        // Show admin panel
        function showAdminPanel() {
            // Check if user is Dan (system admin)
            if (!currentUser || currentUser.username !== 'Dan') {
                alert('Access denied! Only system administrator (Dan) can access the admin panel.');
                return;
            }
            
            showView('adminView');
            updateAdminStatus();
        }

        // Update admin status
        async function updateAdminStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/system/status`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('vocabSize').textContent = data.vocabularySize || words.length;
                    document.getElementById('dbStatus').textContent = data.databaseStatus || 'Normal';
                    document.getElementById('dbStatus').style.color = '#4CAF50';
                } else {
                    document.getElementById('vocabSize').textContent = words.length;
                }
            } catch (error) {
                console.error('Failed to get system status:', error);
                document.getElementById('vocabSize').textContent = words.length;
            }
            
            // Check speech synthesis status
            updateSpeechStatus();
        }
        
        // Update speech synthesis status
        function updateSpeechStatus() {
            const speechStatusElement = document.getElementById('speechStatus');
            
            if ('speechSynthesis' in window) {
                const voices = speechSynthesis.getVoices();
                const americanVoices = voices.filter(voice => voice.lang === 'en-US');
                
                if (americanVoices.length > 0) {
                    speechStatusElement.textContent = `Available (${americanVoices.length} US voices)`;
                    speechStatusElement.style.color = '#4CAF50';
                } else if (voices.length > 0) {
                    speechStatusElement.textContent = 'Available (No US voices)';
                    speechStatusElement.style.color = '#ff9800';
                } else {
                    speechStatusElement.textContent = 'Loading...';
                    speechStatusElement.style.color = '#666';
                    // Try again after a delay
                    setTimeout(updateSpeechStatus, 1000);
                }
            } else {
                speechStatusElement.textContent = 'Not supported';
                speechStatusElement.style.color = '#f44336';
            }
        }

        // Handle CSV upload
        function handleCSVUpload(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        // Handle file upload
        async function handleFileUpload(file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }
            
            // Show progress components
            const statusDiv = document.getElementById('uploadStatus');
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressPercentage = document.getElementById('uploadPercentage');
            const progressDetails = document.getElementById('uploadDetails');
            
            statusDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            
            // Reset progress
            progressBar.style.width = '0%';
            progressPercentage.textContent = '0%';
            progressDetails.textContent = 'Preparing upload...';
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('csv', file);
            
            try {
                // Simulate upload progress stages
                await updateProgress(10, 'Reading CSV file...');
                
                // Read and validate CSV
                const csvText = await file.text();
                const lines = csvText.split('\n').filter(line => line.trim());
                const wordCount = Math.max(0, lines.length - 1); // Exclude header
                
                await updateProgress(20, `Found ${wordCount} words to process...`);
                
                // Upload to server with XMLHttpRequest for progress tracking
                const uploadProgress = await uploadWithProgress(formData, (percent, stage) => {
                    updateProgress(20 + percent * 0.8, stage);
                });
                
                const result = uploadProgress.result;
                
                if (result.success) {
                    await updateProgress(100, `Successfully imported ${result.imported} words!`);
                    
                    // Show success message
                    setTimeout(() => {
                        statusDiv.style.display = 'block';
                        statusDiv.innerHTML = `<div style="color: #4CAF50;">✅ ${result.message}</div>`;
                        progressDiv.style.display = 'none';
                    }, 1000);
                    
                    // Refresh word list
                    await loadWordsFromServer();
                    updateAdminStatus();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                progressDiv.style.display = 'none';
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = `<div style="color: #f44336;">❌ Upload failed: ${error.message}</div>`;
            }
        }
        
        // Update progress bar
        async function updateProgress(percent, message) {
            const progressBar = document.getElementById('uploadProgressBar');
            const progressPercentage = document.getElementById('uploadPercentage');
            const progressDetails = document.getElementById('uploadDetails');
            
            progressBar.style.width = `${percent}%`;
            progressPercentage.textContent = `${Math.round(percent)}%`;
            progressDetails.textContent = message;
            
            // Small delay for visual effect
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // Upload with progress tracking
        function uploadWithProgress(formData, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        onProgress(percent * 0.3, 'Uploading file...');
                    }
                });
                
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        try {
                            const result = JSON.parse(xhr.responseText);
                            resolve({ result });
                        } catch (e) {
                            reject(new Error('Invalid server response'));
                        }
                    } else {
                        reject(new Error(`Upload failed with status ${xhr.status}`));
                    }
                });
                
                xhr.addEventListener('error', () => {
                    reject(new Error('Network error during upload'));
                });
                
                // Simulate processing stages
                xhr.addEventListener('loadstart', () => {
                    onProgress(30, 'Processing words with dictionary API...');
                });
                
                xhr.addEventListener('loadend', () => {
                    if (xhr.status === 200) {
                        onProgress(90, 'Saving to database...');
                    }
                });
                
                xhr.open('POST', `${API_BASE_URL}/upload/csv`);
                xhr.send(formData);
            });
        }

        // Parse CSV and get dictionary information
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const newWords = [];
            
            lines.forEach((line, index) => {
                if (index === 0 && line.toLowerCase().includes('word')) return; // Skip header
                const [word, level] = line.split(',').map(s => s.trim());
                if (word && level) {
                    newWords.push({ word, level });
                }
            });
            
            if (newWords.length > 0) {
                enrichWordsWithDictionary(newWords);
            }
        }

        // Enrich words with dictionary API
        async function enrichWordsWithDictionary(newWords) {
            const enrichedWords = [];
            let processed = 0;
            
            for (let wordObj of newWords) {
                try {
                    const enrichedWord = await mockDictionaryAPI(wordObj.word, wordObj.level);
                    enrichedWords.push(enrichedWord);
                    processed++;
                    console.log(`Processed ${processed}/${newWords.length}: ${wordObj.word}`);
                } catch (error) {
                    console.error(`Failed to get info for word ${wordObj.word}:`, error);
                    enrichedWords.push({
                        word: wordObj.word,
                        level: wordObj.level,
                        phonetics: '',
                        pos: '',
                        definition: 'Definition needed',
                        example: ''
                    });
                }
            }
            
            // Merge with existing words
            words = [...words, ...enrichedWords];
            updateAdminStatus();
            alert(`Successfully imported ${enrichedWords.length} words!`);
        }

        // Mock dictionary API (replace with real API in production)
        async function mockDictionaryAPI(word, level) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Try to get real dictionary data
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (response.ok) {
                    const data = await response.json();
                    const entry = data[0];
                    const meaning = entry.meanings[0];
                    const definition = meaning.definitions[0];
                    
                    return {
                        word,
                        level,
                        phonetics: entry.phonetic || (entry.phonetics[0] && entry.phonetics[0].text) || '',
                        pos: meaning.partOfSpeech || '',
                        definition: definition.definition || '',
                        example: definition.example || `Example sentence with ${word}.`
                    };
                }
            } catch (error) {
                console.error(`Dictionary API failed for ${word}:`, error);
            }
            
            // Fallback mock data
            return {
                word,
                level,
                phonetics: `/${word}/`,
                pos: 'word',
                definition: `Definition of ${word}`,
                example: `Example sentence with ${word}.`
            };
        }

        // Check API status
        async function checkApiStatus() {
            try {
                // First check our server
                const serverResponse = await fetch(`${API_BASE_URL}/system/status`);
                if (serverResponse.ok) {
                    const serverData = await serverResponse.json();
                    document.getElementById('dbStatus').textContent = serverData.databaseStatus || 'Normal';
                    document.getElementById('dbStatus').style.color = '#4CAF50';
                    document.getElementById('vocabSize').textContent = serverData.vocabularySize || 0;
                }
                
                // Then check dictionary API
                const dictResponse = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/test');
                document.getElementById('apiStatus').textContent = 'Connected';
                document.getElementById('apiStatus').style.color = '#4CAF50';
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'Offline';
                document.getElementById('apiStatus').style.color = '#f44336';
                console.log('Dictionary API check failed:', error);
            }
        }

        // Refresh dictionary data
        async function refreshDictionary() {
            if (confirm('This will reload all words from the server. Continue?')) {
                try {
                    await loadWordsFromServer();
                    await updateAdminStatus();
                    alert('Dictionary data refreshed successfully!');
                } catch (error) {
                    alert('Failed to refresh dictionary data: ' + error.message);
                }
            }
        }

        // Reset learning progress
        function resetProgress() {
            if (confirm('Are you sure you want to reset all learning progress? This will delete all learning records!')) {
                userProgress = {
                    learnedWords: [],
                    reviewSchedule: {},
                    streak: 0,
                    lastStudyDate: null,
                    todayLearned: 0,
                    todayReviewed: 0
                };
                saveUserProgress();
                updateDashboard();
                alert('Learning progress has been reset!');
            }
        }

        // Export data
        function exportData() {
            const data = {
                user: currentUser,
                progress: userProgress,
                words: words
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vocabulary_data_${currentUser.username}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Back to dashboard
        function backToDashboard() {
            showView('dashboardView');
            updateDashboard();
        }

        // Check for saved login state
        async function checkSavedLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('Found saved login:', currentUser.username);
                    
                    // Verify the user still exists in the system
                    if (STUDENT_ACCOUNTS[currentUser.username]) {
                        loadUserProgress();
                        showMainSection();
                        console.log('Auto-login successful');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to restore saved login:', error);
                }
                
                // Clear invalid saved login
                localStorage.removeItem('currentUser');
                currentUser = null;
            }
            
            // Show login form if no valid saved login
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
        }
        
        // Logout
        function logout() {
            currentUser = null;
            
            // Clear login state from localStorage
            localStorage.removeItem('currentUser');
            
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('loginForm').reset();
        }
        
        // Pronounce word from word list
        function pronounceWordInList(word) {
            if (!word) return;
            
            // Temporarily set the word for pronunciation
            const tempCurrentWord = currentWord;
            currentWord = { word: word };
            
            pronounceWord();
            
            // Restore the original current word
            currentWord = tempCurrentWord;
        }
        
        // Test pronunciation function (for debugging)
        function testPronunciation() {
            if ('speechSynthesis' in window) {
                const voices = speechSynthesis.getVoices();
                console.log('Testing pronunciation...');
                console.log('Available voices:', voices.length);
                
                const americanVoices = voices.filter(voice => voice.lang === 'en-US');
                console.log('American voices:', americanVoices.map(v => v.name));
                
                const testWord = 'hello';
                const utterance = new SpeechSynthesisUtterance(testWord);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                
                const bestVoice = findBestAmericanVoice(voices);
                if (bestVoice) {
                    utterance.voice = bestVoice;
                    console.log(`Testing with voice: ${bestVoice.name}`);
                }
                
                speechSynthesis.speak(utterance);
            }
        }
        
        // Create test CSV file
        function createTestCSV() {
            const csvContent = `word
apple
beautiful  
computer
education
knowledge
accomplish
university
research
analyze
development
environment
important
different
example
student`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test_vocabulary.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Flashcard functions
        function flipCard() {
            if (!isFlashcardFlipped) {
                showFlashcardBack();
            } else {
                showFlashcardFront();
            }
        }
        
        function showFlashcardFront() {
            document.getElementById('flashcardFront').classList.remove('hidden');
            document.getElementById('flashcardBack').classList.add('hidden');
            isFlashcardFlipped = false;
        }
        
        function showFlashcardBack() {
            const container = document.getElementById('flashcardContainer');
            container.classList.add('flip-animation');
            
            setTimeout(() => {
                document.getElementById('flashcardFront').classList.add('hidden');
                document.getElementById('flashcardBack').classList.remove('hidden');
                isFlashcardFlipped = true;
                
                // Reset sentence input and answer details
                const sentenceInput = document.getElementById('sentenceInput');
                const sentenceResult = document.getElementById('sentenceResult');
                const revealAnswerSection = document.getElementById('revealAnswerSection');
                const answerDetails = document.getElementById('answerDetails');
                const existingFeedback = document.getElementById('difficultyFeedback');
                
                sentenceInput.value = '';
                sentenceResult.textContent = '';
                sentenceResult.className = '';
                sentenceAnswerChecked = false;
                revealAnswerSection.style.display = 'none';
                answerDetails.classList.add('hidden');
                
                // Remove previous difficulty feedback
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                container.classList.remove('flip-animation');
            }, 300);
        }
        
        // Generate sentence fill exercise
        function generateSentenceFillExercise(word) {
            if (!word.example) return;
            
            const sentenceBlankDiv = document.getElementById('sentenceWithBlank');
            const sentenceInput = document.getElementById('sentenceInput');
            const sentenceResult = document.getElementById('sentenceResult');
            
            // Create sentence with blank
            let sentence = word.example;
            const wordToReplace = word.word;
            
            // Try different variations of the word
            const variations = [
                wordToReplace.toLowerCase(),
                wordToReplace.charAt(0).toUpperCase() + wordToReplace.slice(1).toLowerCase(),
                wordToReplace.toUpperCase()
            ];
            
            let replacedSentence = sentence;
            let foundWord = false;
            
            for (const variation of variations) {
                if (sentence.includes(variation)) {
                    replacedSentence = sentence.replace(variation, '______');
                    foundWord = true;
                    break;
                }
            }
            
            // If word not found in example, create a simple sentence
            if (!foundWord) {
                const templates = [
                    `I think this ${word.pos === 'adjective' ? 'is' : 'word is'} ______.`,
                    `The ______ ${word.pos === 'verb' ? 'is important' : 'means something'}.`,
                    `Let me use ______ in a sentence.`,
                    `Can you explain what ______ means?`
                ];
                const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
                replacedSentence = randomTemplate;
            }
            
            sentenceBlankDiv.innerHTML = `"${replacedSentence}"`;
            sentenceInput.value = '';
            sentenceResult.textContent = '';
            sentenceResult.className = '';
            
            // Add Enter key support
            sentenceInput.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    checkSentenceAnswer();
                }
            };
        }
        
        // Check sentence answer
        function checkSentenceAnswer() {
            if (sentenceAnswerChecked) return;
            
            const sentenceInput = document.getElementById('sentenceInput');
            const sentenceResult = document.getElementById('sentenceResult');
            const revealAnswerSection = document.getElementById('revealAnswerSection');
            const userAnswer = sentenceInput.value.trim().toLowerCase();
            const correctAnswer = currentWord.word.toLowerCase();
            
            if (userAnswer === correctAnswer) {
                sentenceResult.textContent = '🎉 Excellent! Correct answer!';
                sentenceResult.className = 'sentence-correct';
                sentenceInput.style.borderColor = '#4CAF50';
                sentenceInput.style.backgroundColor = '#e8f5e8';
                currentWordCorrect = true;
            } else {
                sentenceResult.innerHTML = `❌ Not quite right. Try to think about the meaning...`;
                sentenceResult.className = 'sentence-incorrect';
                sentenceInput.style.borderColor = '#f44336';
                sentenceInput.style.backgroundColor = '#ffebee';
                currentWordCorrect = false;
            }
            
            sentenceAnswerChecked = true;
            
            // Show the reveal answer button
            revealAnswerSection.style.display = 'block';
            
            // Disable further input
            sentenceInput.disabled = true;
            
            // Add automatic difficulty assessment feedback
            setTimeout(() => {
                const difficultyFeedback = document.createElement('div');
                difficultyFeedback.id = 'difficultyFeedback';
                difficultyFeedback.style.cssText = 'margin-top: 15px; padding: 10px; border-radius: 8px; text-align: center; font-size: 14px;';
                
                if (currentWordCorrect) {
                    difficultyFeedback.style.background = '#e8f5e8';
                    difficultyFeedback.style.color = '#2e7d32';
                    difficultyFeedback.innerHTML = '✅ <strong>Auto-assessed:</strong> You got it right! This word will be reviewed less frequently.';
                } else {
                    difficultyFeedback.style.background = '#ffebee';
                    difficultyFeedback.style.color = '#c62828';
                    difficultyFeedback.innerHTML = '📚 <strong>Auto-assessed:</strong> Need more practice. This word will appear more often for review.';
                }
                
                // Remove existing feedback if any
                const existingFeedback = document.getElementById('difficultyFeedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                // Add new feedback
                revealAnswerSection.parentNode.insertBefore(difficultyFeedback, revealAnswerSection.nextSibling);
            }, 1000);
            
            // Re-enable after moving to next word
            setTimeout(() => {
                sentenceInput.disabled = false;
                sentenceInput.style.borderColor = '#e1e5e9';
                sentenceInput.style.backgroundColor = '#fff';
            }, 3000);
        }
        
        // Reveal full answer details
        function revealAnswer() {
            const answerDetails = document.getElementById('answerDetails');
            const revealButton = document.querySelector('#revealAnswerSection button');
            
            if (answerDetails.classList.contains('hidden')) {
                answerDetails.classList.remove('hidden');
                revealButton.textContent = 'Hide Answer 🙈';
                revealButton.className = 'btn btn-secondary';
                
                // Scroll to show the answer
                setTimeout(() => {
                    answerDetails.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            } else {
                answerDetails.classList.add('hidden');
                revealButton.textContent = 'Show Full Answer 👁️';
                revealButton.className = 'btn btn-warning';
            }
        }

        // Math module functions
        async function showMathTopics() {
            showView('mathTopicsView');
            await loadMathTopics();
        }

        async function loadMathTopics(gradeLevel = '') {
            try {
                let url;
                if (currentUser && currentUser.id) {
                    // Load topics based on user's grade access
                    url = `${API_BASE_URL}/math/topics/user/${currentUser.id}`;
                    if (gradeLevel) {
                        url += `?grade_level=${gradeLevel}`;
                    }
                } else {
                    // Fallback to all topics if no user
                    url = gradeLevel ? 
                        `${API_BASE_URL}/math/topics?grade_level=${gradeLevel}` : 
                        `${API_BASE_URL}/math/topics`;
                }
                
                const response = await fetch(url);
                const topics = await response.json();
                
                displayMathTopics(topics);
            } catch (error) {
                console.error('Failed to load math topics:', error);
            }
        }

        function displayMathTopics(topics) {
            const container = document.getElementById('mathTopicsContainer');
            
            if (topics.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No math topics found</div>';
                return;
            }

            // Group topics by category and grade level
            const grouped = {};
            topics.forEach(topic => {
                const key = `${topic.grade_level} - ${topic.category}`;
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(topic);
            });

            let html = '';
            Object.keys(grouped).forEach(groupKey => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 5px;">
                            ${groupKey}
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                `;
                
                grouped[groupKey].forEach(topic => {
                    const knowledgePointsHtml = topic.knowledge_points ? 
                        `<div style="font-size: 12px; color: #555; margin-top: 10px; background: #fff; padding: 10px; border-radius: 5px;">
                            <strong>Knowledge Points:</strong><br>
                            <div style="white-space: pre-line; margin-top: 5px;">${topic.knowledge_points}</div>
                        </div>` : '';
                    
                    html += `
                        <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; background: #f8f9fa;">
                            <h5 style="color: #333; margin-bottom: 10px;">${topic.topic_name}</h5>
                            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">${topic.description}</p>
                            <div style="font-size: 12px; color: #888;">
                                <strong>Learning Objectives:</strong><br>
                                ${topic.learning_objectives}
                            </div>
                            ${knowledgePointsHtml}
                            <div style="margin-top: 15px; text-align: center;">
                                <button class="btn btn-success" onclick="setMathGoal(${topic.id}, '${topic.topic_name}')" style="padding: 8px 16px; font-size: 14px;">
                                    📚 Set as Today's Goal
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function filterMathTopics() {
            const gradeLevel = document.getElementById('gradeFilter').value;
            loadMathTopics(gradeLevel);
        }

        // Practice session variables
        let practiceSession = {
            problems: [],
            currentIndex: 0,
            answers: [],
            startTime: null,
            topicName: '',
            timer: null
        };

        async function showMathPractice() {
            showView('mathPracticeView');
            await loadTopicsForPractice();
        }

        async function loadTopicsForPractice() {
            try {
                const response = await fetch(`${API_BASE_URL}/math/topics`);
                const topics = await response.json();
                
                const select = document.getElementById('practiceTopicSelect');
                select.innerHTML = '<option value="">Select a math topic...</option>';
                
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = `${topic.grade_level} - ${topic.topic_name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load topics for practice:', error);
            }
        }

        async function startPracticeSession() {
            const topicId = document.getElementById('practiceTopicSelect').value;
            const difficulty = document.getElementById('practiceDifficulty').value;
            
            if (!topicId) {
                alert('Please select a topic to practice');
                return;
            }
            
            try {
                const url = `${API_BASE_URL}/practice/${topicId}?limit=5` + 
                           (difficulty ? `&difficulty=${difficulty}` : '');
                
                const response = await fetch(url);
                const problems = await response.json();
                
                if (problems.length === 0) {
                    alert('No practice problems available for this topic. Please try another topic.');
                    return;
                }
                
                // Initialize practice session
                practiceSession.problems = problems;
                practiceSession.currentIndex = 0;
                practiceSession.answers = [];
                practiceSession.startTime = Date.now();
                practiceSession.topicName = problems[0].topic_name;
                
                // Start timer
                startPracticeTimer();
                
                // Show practice area and load first problem
                document.getElementById('practiceSessionArea').style.display = 'block';
                loadCurrentProblem();
                
            } catch (error) {
                console.error('Failed to start practice session:', error);
                alert('Failed to load practice problems. Please try again.');
            }
        }

        function startPracticeTimer() {
            let seconds = 0;
            practiceSession.timer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('timer').textContent = 
                    `Time: ${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function loadCurrentProblem() {
            const problem = practiceSession.problems[practiceSession.currentIndex];
            
            // Update progress
            document.getElementById('currentProblemNumber').textContent = practiceSession.currentIndex + 1;
            document.getElementById('totalProblems').textContent = practiceSession.problems.length;
            
            // Display question
            document.getElementById('problemQuestion').textContent = problem.question;
            
            // Hide all answer areas first
            document.getElementById('multipleChoiceOptions').style.display = 'none';
            document.getElementById('shortAnswerInput').style.display = 'none';
            document.getElementById('answerResult').style.display = 'none';
            
            // Show appropriate answer input
            if (problem.problem_type === 'multiple_choice' && problem.options) {
                setupMultipleChoice(problem);
            } else {
                setupShortAnswer();
            }
            
            // Show submit button
            document.getElementById('submitAnswer').style.display = 'inline-block';
        }

        function setupMultipleChoice(problem) {
            document.getElementById('multipleChoiceOptions').style.display = 'block';
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            problem.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'margin: 10px 0; padding: 15px; border: 2px solid #e1e5e9; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;';
                div.innerHTML = `
                    <label style="cursor: pointer; display: flex; align-items: center; font-size: 16px;">
                        <input type="radio" name="practiceAnswer" value="${option}" style="margin-right: 10px; transform: scale(1.2);">
                        ${option}
                    </label>
                `;
                
                div.addEventListener('click', () => {
                    div.querySelector('input').checked = true;
                    // Remove selection from others
                    container.querySelectorAll('div').forEach(d => {
                        d.style.background = '#fff';
                        d.style.borderColor = '#e1e5e9';
                    });
                    // Highlight selected
                    div.style.background = '#e8f4fd';
                    div.style.borderColor = '#667eea';
                });
                
                container.appendChild(div);
            });
        }

        function setupShortAnswer() {
            document.getElementById('shortAnswerInput').style.display = 'block';
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            
            // Add Enter key support
            document.getElementById('answerInput').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    submitPracticeAnswer();
                }
            };
        }

        async function submitPracticeAnswer() {
            const problem = practiceSession.problems[practiceSession.currentIndex];
            let userAnswer = '';
            
            if (problem.problem_type === 'multiple_choice') {
                const selected = document.querySelector('input[name="practiceAnswer"]:checked');
                if (!selected) {
                    alert('Please select an answer');
                    return;
                }
                userAnswer = selected.value;
            } else {
                userAnswer = document.getElementById('answerInput').value.trim();
                if (!userAnswer) {
                    alert('Please enter an answer');
                    return;
                }
            }
            
            const timeTaken = Math.floor((Date.now() - practiceSession.startTime) / 1000);
            
            try {
                const response = await fetch(`${API_BASE_URL}/practice/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        problemId: problem.id,
                        userAnswer: userAnswer,
                        timeTaken: timeTaken
                    })
                });
                
                const result = await response.json();
                
                // Store answer result
                practiceSession.answers.push({
                    problem: problem,
                    userAnswer: userAnswer,
                    correct: result.correct,
                    correctAnswer: result.correctAnswer,
                    explanation: result.explanation
                });
                
                // Show result
                showAnswerResult(result);
                
            } catch (error) {
                console.error('Failed to submit answer:', error);
                alert('Failed to submit answer. Please try again.');
            }
        }

        function showAnswerResult(result) {
            document.getElementById('submitAnswer').style.display = 'none';
            
            const resultDiv = document.getElementById('answerResult');
            const messageDiv = document.getElementById('resultMessage');
            const correctDiv = document.getElementById('correctAnswer');
            const explanationDiv = document.getElementById('explanation');
            
            if (result.correct) {
                resultDiv.style.background = '#e8f5e8';
                resultDiv.style.border = '2px solid #4CAF50';
                messageDiv.innerHTML = '🎉 Correct! Well done!';
                messageDiv.style.color = '#4CAF50';
                correctDiv.style.display = 'none';
            } else {
                resultDiv.style.background = '#ffebee';
                resultDiv.style.border = '2px solid #f44336';
                messageDiv.innerHTML = '❌ Incorrect, but keep trying!';
                messageDiv.style.color = '#f44336';
                correctDiv.innerHTML = `<strong>Correct Answer:</strong> ${result.correctAnswer}`;
                correctDiv.style.display = 'block';
            }
            
            explanationDiv.innerHTML = `<strong>Explanation:</strong> ${result.explanation}`;
            resultDiv.style.display = 'block';
            
            // Update next button text
            const nextBtn = document.getElementById('nextProblem');
            if (practiceSession.currentIndex >= practiceSession.problems.length - 1) {
                nextBtn.textContent = 'Finish Session ✅';
            } else {
                nextBtn.textContent = 'Next Problem ➡️';
            }
        }

        function loadNextProblem() {
            practiceSession.currentIndex++;
            
            if (practiceSession.currentIndex >= practiceSession.problems.length) {
                finishPracticeSession();
            } else {
                loadCurrentProblem();
            }
        }

        function finishPracticeSession() {
            clearInterval(practiceSession.timer);
            
            // Calculate stats
            const correct = practiceSession.answers.filter(a => a.correct).length;
            const total = practiceSession.answers.length;
            const accuracy = Math.round((correct / total) * 100);
            const totalTime = Math.floor((Date.now() - practiceSession.startTime) / 1000);
            const avgTime = Math.floor(totalTime / total);
            
            // Hide current problem and show results
            document.getElementById('currentProblem').style.display = 'none';
            document.getElementById('answerResult').style.display = 'none';
            
            // Show session complete
            const statsDiv = document.getElementById('sessionStats');
            statsDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">Session Results for: ${practiceSession.topicName}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">${correct}/${total}</div>
                            <div style="color: #666;">Correct</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${accuracy}%</div>
                            <div style="color: #666;">Accuracy</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${Math.floor(totalTime/60)}:${(totalTime%60).toString().padStart(2,'0')}</div>
                            <div style="color: #666;">Total Time</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">${avgTime}s</div>
                            <div style="color: #666;">Avg/Problem</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sessionComplete').style.display = 'block';
        }

        function startNewSession() {
            // Reset session
            document.getElementById('practiceSessionArea').style.display = 'none';
            document.getElementById('currentProblem').style.display = 'block';
            document.getElementById('sessionComplete').style.display = 'none';
            
            // Clear selections
            document.getElementById('practiceTopicSelect').value = '';
            document.getElementById('practiceDifficulty').value = '';
        }

        function showMathProgress() {
            alert('Math progress tracking coming soon! 📊');
        }

        // Custom Questions functions
        async function showCustomQuestions() {
            showView('customQuestionsView');
            await loadCustomQuestions();
        }

        async function loadCustomQuestions() {
            if (!currentUser || !currentUser.id) {
                document.getElementById('customQuestionsList').innerHTML = 
                    '<div style="text-align: center; color: #666; padding: 40px;"><p>Please login to view your custom questions.</p></div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/custom-questions/${currentUser.id}`);
                const questions = await response.json();
                
                displayCustomQuestions(questions);
            } catch (error) {
                console.error('Failed to load custom questions:', error);
                document.getElementById('customQuestionsList').innerHTML = 
                    '<div style="text-align: center; color: #ff6b6b; padding: 40px;"><p>Error loading questions. Please try again.</p></div>';
            }
        }

        function displayCustomQuestions(questions) {
            const container = document.getElementById('customQuestionsList');
            
            if (questions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;"><p>No custom questions found. Upload some questions above!</p></div>';
                return;
            }

            // Group questions by category
            const grouped = {};
            questions.forEach(q => {
                if (!grouped[q.category]) {
                    grouped[q.category] = [];
                }
                grouped[q.category].push(q);
            });

            let html = '';
            Object.keys(grouped).forEach(category => {
                const categoryQuestions = grouped[category];
                const completedCount = categoryQuestions.filter(q => q.completed).length;
                
                html += `
                    <div style="margin-bottom: 30px; border: 1px solid #e1e5e9; border-radius: 10px; overflow: hidden;">
                        <div style="background: #667eea; color: white; padding: 15px; font-weight: bold; text-align: center;">
                            ${category} (${completedCount}/${categoryQuestions.length} completed)
                        </div>
                        <div style="padding: 20px;">
                `;
                
                categoryQuestions.forEach((question, index) => {
                    const questionNumber = index + 1;
                    const statusColor = question.completed ? '#4CAF50' : '#666';
                    const statusIcon = question.completed ? '✅' : '⏳';
                    const formattedQuestion = formatQuestionDisplay(question.question);
                    
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin: 5px 0; background: ${question.completed ? '#f0f9ff' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${statusColor};">
                            <div style="flex: 1;">
                                <strong>${questionNumber}.</strong> ${formattedQuestion}
                                ${question.answer && question.answer !== 'variable_solution' && question.answer !== 'fraction_result' ? 
                                    `<span style="color: #666; margin-left: 10px;">(Answer: ${question.answer})</span>` : ''}
                            </div>
                            <div>
                                ${statusIcon}
                                ${!question.completed ? `<button class="btn btn-sm btn-success" onclick="markQuestionCompleted(${question.id})" style="margin-left: 10px; padding: 4px 8px;">Mark Done</button>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function formatQuestionDisplay(question) {
            let formatted = question
                .replace(/\*/g, '×')
                .replace(/\s*\+\s*/g, ' + ')
                .replace(/\s*-\s*/g, ' - ')
                .replace(/\s*×\s*/g, ' × ')
                .replace(/\s*÷\s*/g, ' ÷ ');
            
            // Format fractions using our math fraction CSS
            formatted = formatted.replace(/(\d+)\/(\d+)/g, function(match, num, den) {
                return `<span class="math-fraction">
                    <span class="numerator">${num}</span>
                    <span class="denominator">${den}</span>
                </span>`;
            });
            
            return `<span class="math-expression">${formatted}</span>`;
        }

        async function uploadCustomQuestions() {
            const content = document.getElementById('questionsContent').value.trim();
            
            if (!content) {
                alert('Please enter some questions to upload.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/upload-questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(`${result.message}`);
                    document.getElementById('questionsContent').value = '';
                    await loadCustomQuestions();
                } else {
                    alert('Error uploading questions: ' + result.error);
                }
            } catch (error) {
                console.error('Failed to upload questions:', error);
                alert('Failed to upload questions. Please try again.');
            }
        }

        async function markQuestionCompleted(questionId) {
            try {
                const response = await fetch(`${API_BASE_URL}/custom-questions/${questionId}/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadCustomQuestions(); // Reload to show updated status
                } else {
                    alert('Failed to mark question as completed.');
                }
            } catch (error) {
                console.error('Failed to mark question as completed:', error);
                alert('Failed to mark question as completed. Please try again.');
            }
        }

        // Goal management functions
        async function showGoalSetup() {
            showView('goalSetupView');
            await loadMathTopicsForGoals();
        }

        async function loadMathTopicsForGoals() {
            try {
                const response = await fetch(`${API_BASE_URL}/math/topics`);
                const topics = await response.json();
                
                const select = document.getElementById('mathTopicSelect');
                select.innerHTML = '<option value="">Select a math topic to study today</option>';
                
                topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.textContent = `${topic.grade_level} - ${topic.topic_name}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load math topics for goals:', error);
            }
        }

        async function createDailyGoals() {
            if (!currentUser || !currentUser.id) return;
            
            const vocabCount = parseInt(document.getElementById('vocabGoalCount').value);
            const reviewCount = parseInt(document.getElementById('reviewGoalCount').value);
            const mathTopicId = document.getElementById('mathTopicSelect').value;
            const readingMinutes = parseInt(document.getElementById('readingGoalMinutes').value);
            
            try {
                // Create vocabulary learning goal
                if (vocabCount > 0) {
                    await createGoal('vocabulary_learn', vocabCount);
                }
                
                // Create vocabulary review goal
                if (reviewCount > 0) {
                    await createGoal('vocabulary_review', reviewCount);
                }
                
                // Create math goal
                if (mathTopicId) {
                    await createGoal('math', 1, mathTopicId);
                }
                
                // Create reading goal
                if (readingMinutes > 0) {
                    await createGoal('reading', readingMinutes);
                }
                
                alert('🎉 Daily goals set successfully!');
                backToDashboard();
                loadDailyGoals();
                
            } catch (error) {
                console.error('Failed to create daily goals:', error);
                alert('Failed to set daily goals. Please try again.');
            }
        }

        async function createGoal(goalType, targetCount, targetItemId = null) {
            const response = await fetch(`${API_BASE_URL}/goals`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.id,
                    goalType: goalType,
                    targetCount: targetCount,
                    targetItemId: targetItemId
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to create goal');
            }
            
            return response.json();
        }

        async function setMathGoal(topicId, topicName) {
            if (!currentUser || !currentUser.id) return;
            
            try {
                await createGoal('math', 1, topicId);
                alert(`✅ Set "${topicName}" as today's math goal!`);
                backToDashboard();
                loadDailyGoals();
            } catch (error) {
                console.error('Failed to set math goal:', error);
                alert('Failed to set math goal. Please try again.');
            }
        }

        async function loadDailyGoals() {
            if (!currentUser || !currentUser.id) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/goals/${currentUser.id}`);
                const goals = await response.json();
                
                displayDailyGoals(goals);
            } catch (error) {
                console.error('Failed to load daily goals:', error);
            }
        }

        function displayDailyGoals(goals) {
            const container = document.getElementById('dailyGoalsContainer');
            
            if (goals.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>No goals set for today</p>
                        <p style="font-size: 14px;">Click "Set Today's Goals" to create your learning plan!</p>
                    </div>
                `;
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            goals.forEach(goal => {
                const progress = goal.target_count > 0 ? (goal.completed_count / goal.target_count) * 100 : 0;
                const isCompleted = goal.is_completed;
                
                let goalIcon = '📚';
                let goalText = '';
                
                switch (goal.goal_type) {
                    case 'vocabulary_learn':
                        goalIcon = '📚';
                        goalText = `Learn ${goal.target_count} new words`;
                        break;
                    case 'vocabulary_review':
                        goalIcon = '🔄';
                        goalText = `Review ${goal.target_count} words`;
                        break;
                    case 'math':
                        goalIcon = '🔢';
                        goalText = `Study: ${goal.target_name || 'Math topic'}`;
                        break;
                    case 'reading':
                        goalIcon = '📖';
                        goalText = `Read for ${goal.target_count} minutes`;
                        break;
                }
                
                html += `
                    <div style="border: 2px solid ${isCompleted ? '#4CAF50' : '#e1e5e9'}; border-radius: 10px; padding: 15px; background: ${isCompleted ? '#e8f5e8' : '#fff'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 16px;">${goalIcon} ${goalText}</span>
                            ${isCompleted ? '<span style="color: #4CAF50; font-size: 20px;">✅</span>' : ''}
                        </div>
                        <div style="background: #f0f0f0; border-radius: 5px; height: 8px; margin-bottom: 10px;">
                            <div style="background: ${isCompleted ? '#4CAF50' : '#667eea'}; height: 100%; border-radius: 5px; width: ${progress}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #666;">${goal.completed_count}/${goal.target_count} completed</span>
                            ${!isCompleted ? `<button class="btn btn-success" onclick="completeGoal(${goal.id})" style="padding: 5px 10px; font-size: 12px;">Mark Done</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function completeGoal(goalId) {
            if (!currentUser || !currentUser.id) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/goals/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        goalId: goalId,
                        completionType: 'manual'
                    })
                });
                
                if (response.ok) {
                    loadDailyGoals(); // Refresh the display
                    updateDashboard(); // Update stats
                } else {
                    throw new Error('Failed to complete goal');
                }
            } catch (error) {
                console.error('Failed to complete goal:', error);
                alert('Failed to mark goal as complete. Please try again.');
            }
        }

        // Question Practice System
        let practiceSession = {
            questions: [],
            currentIndex: 0,
            startTime: null,
            timer: null,
            answers: [],
            correctCount: 0
        };

        async function startQuestionPractice() {
            if (!currentUser || !currentUser.id) {
                alert('Please login to start practice.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/custom-questions/${currentUser.id}?completed=false`);
                const questions = await response.json();

                if (questions.length === 0) {
                    alert('No unfinished questions found. Complete the upload first!');
                    return;
                }

                // Filter only calculation and fraction questions
                const mathQuestions = questions.filter(q => 
                    q.question_type === 'calculation' || 
                    q.question_type === 'fraction' || 
                    (q.question.includes('=') && !q.answer.includes('To be solved'))
                );

                if (mathQuestions.length === 0) {
                    alert('No math questions found for practice.');
                    return;
                }

                practiceSession.questions = mathQuestions;
                practiceSession.currentIndex = 0;
                practiceSession.startTime = Date.now();
                practiceSession.answers = [];
                practiceSession.correctCount = 0;

                showView('questionPracticeView');
                startPracticeTimer();
                displayCurrentQuestion();

            } catch (error) {
                console.error('Failed to start practice:', error);
                alert('Failed to start practice. Please try again.');
            }
        }

        function startPracticeTimer() {
            let seconds = 0;
            practiceSession.timer = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById('practiceTimer').textContent = 
                    `Time: ${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function displayCurrentQuestion() {
            const question = practiceSession.questions[practiceSession.currentIndex];
            
            document.getElementById('currentQuestionNum').textContent = practiceSession.currentIndex + 1;
            document.getElementById('totalQuestions').textContent = practiceSession.questions.length;
            document.getElementById('correctAnswers').textContent = practiceSession.correctCount;
            
            // Format and display the question
            const formattedQuestion = formatQuestionDisplay(question.question);
            document.getElementById('questionText').innerHTML = formattedQuestion;
            
            // Reset input and buttons
            document.getElementById('studentAnswer').value = '';
            document.getElementById('studentAnswer').disabled = false;
            document.getElementById('submitAnswerBtn').disabled = false;
            document.getElementById('nextQuestionBtn').classList.add('hidden');
            document.getElementById('answerFeedback').classList.add('hidden');
            
            // Focus on input
            document.getElementById('studentAnswer').focus();
        }

        function submitStudentAnswer() {
            const userAnswer = document.getElementById('studentAnswer').value.trim();
            const question = practiceSession.questions[practiceSession.currentIndex];
            
            if (!userAnswer) {
                alert('Please enter an answer.');
                return;
            }

            // Validate answer
            const isCorrect = validateAnswer(userAnswer, question.answer, question.question_type);
            
            if (isCorrect) {
                practiceSession.correctCount++;
            }

            practiceSession.answers.push({
                question: question.question,
                userAnswer: userAnswer,
                correctAnswer: question.answer,
                correct: isCorrect
            });

            // Show feedback
            showAnswerFeedback(isCorrect, question.answer);
            
            // Update display
            document.getElementById('correctAnswers').textContent = practiceSession.correctCount;
            document.getElementById('submitAnswerBtn').disabled = true;
            document.getElementById('studentAnswer').disabled = true;
            document.getElementById('nextQuestionBtn').classList.remove('hidden');
        }

        function validateAnswer(userAnswer, correctAnswer, questionType) {
            // Normalize answers for comparison
            const userNormalized = userAnswer.toLowerCase().replace(/\s+/g, '');
            const correctNormalized = correctAnswer.toLowerCase().replace(/\s+/g, '');
            
            // Handle different answer types
            if (questionType === 'fraction') {
                return compareFractions(userAnswer, correctAnswer);
            }
            
            // Handle decimal approximations
            const userNum = parseFloat(userAnswer);
            const correctNum = parseFloat(correctAnswer);
            
            if (!isNaN(userNum) && !isNaN(correctNum)) {
                return Math.abs(userNum - correctNum) < 0.01; // Allow small differences
            }
            
            return userNormalized === correctNormalized;
        }

        function compareFractions(answer1, answer2) {
            // Simple fraction comparison - can be enhanced
            const normalize = (frac) => {
                if (frac.includes('/')) {
                    const [num, den] = frac.split('/').map(n => parseFloat(n.trim()));
                    return num / den;
                }
                return parseFloat(frac);
            };
            
            const val1 = normalize(answer1);
            const val2 = normalize(answer2);
            
            if (!isNaN(val1) && !isNaN(val2)) {
                return Math.abs(val1 - val2) < 0.01;
            }
            
            return answer1.trim() === answer2.trim();
        }

        function showAnswerFeedback(isCorrect, correctAnswer) {
            const feedback = document.getElementById('answerFeedback');
            const message = document.getElementById('feedbackMessage');
            const correctDisplay = document.getElementById('correctAnswerDisplay');
            
            if (isCorrect) {
                feedback.style.background = '#d4edda';
                feedback.style.color = '#155724';
                feedback.style.border = '1px solid #c3e6cb';
                message.innerHTML = '✅ <strong>Correct!</strong> Well done!';
                correctDisplay.innerHTML = '';
            } else {
                feedback.style.background = '#f8d7da';
                feedback.style.color = '#721c24';
                feedback.style.border = '1px solid #f5c6cb';
                message.innerHTML = '❌ <strong>Incorrect.</strong> Keep trying!';
                correctDisplay.innerHTML = `<strong>Correct answer:</strong> ${formatQuestionDisplay(correctAnswer)}`;
            }
            
            feedback.classList.remove('hidden');
        }

        function nextQuestion() {
            practiceSession.currentIndex++;
            
            if (practiceSession.currentIndex < practiceSession.questions.length) {
                displayCurrentQuestion();
            } else {
                finishPractice();
            }
        }

        function finishPractice() {
            clearInterval(practiceSession.timer);
            
            const totalTime = Math.floor((Date.now() - practiceSession.startTime) / 1000);
            const accuracy = Math.round((practiceSession.correctCount / practiceSession.questions.length) * 100);
            
            document.getElementById('currentQuestionDisplay').classList.add('hidden');
            document.getElementById('answerFeedback').classList.add('hidden');
            
            const statsHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #4CAF50;">${practiceSession.correctCount}</div>
                        <div style="color: #666;">Correct</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #ff9800;">${practiceSession.questions.length}</div>
                        <div style="color: #666;">Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #2196F3;">${accuracy}%</div>
                        <div style="color: #666;">Accuracy</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #9c27b0;">${Math.floor(totalTime/60)}:${(totalTime%60).toString().padStart(2,'0')}</div>
                        <div style="color: #666;">Time</div>
                    </div>
                </div>
            `;
            
            document.getElementById('finalStats').innerHTML = statsHtml;
            document.getElementById('practiceResults').classList.remove('hidden');
        }

        function restartPractice() {
            document.getElementById('practiceResults').classList.add('hidden');
            document.getElementById('currentQuestionDisplay').classList.remove('hidden');
            
            practiceSession.currentIndex = 0;
            practiceSession.startTime = Date.now();
            practiceSession.answers = [];
            practiceSession.correctCount = 0;
            
            startPracticeTimer();
            displayCurrentQuestion();
        }

        // Allow Enter key to submit answer
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('questionPracticeView').classList.contains('questionPracticeView') === false) {
                    const submitBtn = document.getElementById('submitAnswerBtn');
                    const nextBtn = document.getElementById('nextQuestionBtn');
                    
                    if (!submitBtn.disabled) {
                        submitStudentAnswer();
                    } else if (!nextBtn.classList.contains('hidden')) {
                        nextQuestion();
                    }
                }
            });
        });
    </script>
</body>
</html>