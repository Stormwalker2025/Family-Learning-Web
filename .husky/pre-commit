#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ” Running pre-commit checks..."

# Check if we're committing to protected branches
branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "âŒ Direct commits to main/master branch are not allowed!"
  echo "Please create a feature branch and submit a PR."
  exit 1
fi

# Run lint-staged for staged files
echo "ðŸ“ Checking staged files..."
npx lint-staged

# Type check
echo "ðŸ” Running TypeScript type check..."
npm run type-check

# Test related to staged files
echo "ðŸ§ª Running tests for changed files..."
npm run test:changed

# Security check
echo "ðŸ”’ Running security checks..."
npm run lint:security

# Check for secrets
echo "ðŸ•µï¸ Checking for hardcoded secrets..."
npm run security:secrets

# Check bundle size impact (if package.json or dependencies changed)
if git diff --cached --name-only | grep -E "(package\.json|package-lock\.json)" > /dev/null; then
  echo "ðŸ“¦ Checking bundle size impact..."
  npm run analyze:bundle:check
fi

# Check accessibility if UI components changed
if git diff --cached --name-only | grep -E "\.(tsx|jsx|css|scss)" > /dev/null; then
  echo "â™¿ Running accessibility checks..."
  npm run test:a11y:staged
fi

echo "âœ… All pre-commit checks passed!"